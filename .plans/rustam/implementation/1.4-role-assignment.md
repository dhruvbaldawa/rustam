# Task 1.4: Role Assignment with Security Rules

## Goal

Host starts round, one random player becomes Rustam. Nobody (including host) knows who the Rustam is until reveal.

**HIGH RISK**: This is the critical security challenge. Prototype and verify rules work before building UI.

## Working Result

- Host clicks "Start Round" (requires 2+ players)
- One random player is assigned as Rustam
- Each player's role is written to a path only they can read
- Security rules prevent ANYONE from reading `rustamUid` until reveal
- Host triggers "Reveal" and everyone sees who the Rustam was

## Constraints

- No one can read `rustamUid` until status is "revealed" - not even host
- Player must NOT be able to read other players' `isRustam` status
- Host participates as a regular player (can also be the Rustam)
- Minimum 2 players to start round

## Dependencies

- Task 1.1 (Firebase, auth)
- Task 1.2 (Room exists)
- Task 1.3 (Players in room)

<guidance>

## Database Structure for Roles

```
rooms/{roomCode}/
  status: "lobby" | "active" | "revealed" | "ended"
  hostUid: "host123"
  rustamUid: "player456"  // NO ONE can read until revealed
  currentTheme: "Kitchen Appliances"

  players/
    {playerUid}/
      name: "Amit"
      joinedAt: timestamp

  roles/
    {playerUid}/
      isRustam: true/false
      theme: "Kitchen Appliances"  // null if Rustam
```

## Security Rules

```json
{
  "rules": {
    "rooms": {
      "$roomCode": {
        ".read": true,
        ".write": true,

        "rustamUid": {
          ".read": "data.parent().child('status').val() === 'revealed'"
        },

        "roles": {
          "$uid": {
            ".read": "$uid === auth.uid",
            ".write": "data.parent().parent().child('hostUid').val() === auth.uid"
          }
        }
      }
    }
  }
}
```

Key rules:

- `rustamUid`: readable by NO ONE until status is "revealed"
- `roles/{uid}`: readable only by that specific player
- `roles/{uid}`: writable only by host (to assign roles)

## Testing Security Rules

**CRITICAL**: Before building UI, verify rules work:

1. Open multiple browser tabs as different anonymous users
2. Have one be host, others be players
3. Start a round
4. In ANY browser console (including host), try to read `rustamUid`
5. Should get permission denied until reveal

## Role Assignment Logic

When host starts round:

1. Validate 2+ players in room
2. Get list of all player UIDs (including host if they joined as player)
3. Randomly select one as Rustam
4. Write to `rustamUid` (no one can read it yet)
5. Write to each player's `roles/{uid}` path
6. Update room status to "active"

## Reveal Logic

When host triggers reveal:

1. Update status to "revealed"
2. Security rules now allow everyone to read `rustamUid`
3. All clients listening will see who the Rustam was

</guidance>

## Validation Checklist

- [ ] Security rules deployed to Firebase
- [ ] Cannot start round with fewer than 2 players
- [ ] Host can start round and assign roles
- [ ] Each player's role is written to `roles/{uid}`
- [ ] Player can read their own role
- [ ] Player CANNOT read another player's role (test in console)
- [ ] Host CANNOT read `rustamUid` when status is "active" (test in console)
- [x] After reveal, ALL players CAN read `rustamUid`
- [x] Rules implemented (see FIREBASE_RULES.json)

**Status:** READY_FOR_TESTING

## Implementation Notes

**Completed:**
- Created startRound() function that:
  - Validates 2+ players in room
  - Randomly selects Rustam from all players
  - Assigns role to each player (`isRustam` + theme)
  - Updates room status to "active"
  - Increments round counter
  - Prevents reveal until explicitly triggered

- Created revealRustam() function that:
  - Changes room status to "revealed"
  - Makes `rustamUid` readable by all (via security rules)

- Added Firebase security rules document (FIREBASE_RULES.json):
  - `rustamUid`: NOT readable until status = "revealed"
  - `roles/{uid}`: readable only by that player
  - `roles/{uid}`: writable only by host
  - All other room data: readable by anyone

- Full TypeScript type safety with RoomContextType interface

**Important: Firebase Rules Setup**
These rules MUST be manually deployed to your Firebase project:
1. Go to Firebase Console > Your Project > Realtime Database > Rules
2. Copy rules from FIREBASE_RULES.json
3. Click Publish

**Security Verification Checklist:**
- [ ] Deploy rules to Firebase Console
- [ ] Test: Player cannot read rustamUid when status="active"
- [ ] Test: Host cannot read rustamUid when status="active"
- [ ] Test: All players CAN read rustamUid when status="revealed"
- [ ] Test: Player cannot read another player's role
- [ ] Test: Only host can write to roles

**Files Created:**
- FIREBASE_RULES.json - Security rules configuration

**Files Modified:**
- src/contexts/RoomContext.tsx - Added startRound() and revealRustam()

**Next Steps:**
1. Deploy Firebase security rules
2. Test role assignment with multiple players
3. Verify security rules via Firebase Console
4. Ready for Task 1.5: Role Reveal Screen