# Task 1.6: Round Cycling and Game Flow

## Goal

Complete game loop: host controls round flow, multiple rounds can be played, game ends cleanly.

## Working Result

- Host can start round → reveal Rustam → start next round
- Round counter tracks progress (Round 2 of 4)
- After final round, game ends
- All state transitions sync to all players in real-time
- Host can end game early if needed

## Constraints

- Support 3-5 rounds (configurable by host in lobby)
- Hardcode theme for MVP (e.g., cycle through first 3 themes)
- Clear state transitions visible to all players

## Dependencies

- Task 1.4 (Role assignment)
- Task 1.5 (Role reveal screen)

<guidance>

## Game State Machine

```
lobby → active → revealed → active → revealed → ... → ended
        ↑____________________↓
           (next round)
```

States:

- `lobby`: Waiting for players, host can configure rounds
- `active`: Round in progress, players see their roles
- `revealed`: Rustam identity shown to all
- `ended`: Game over

## Host Controls

**During lobby:**

- See player count
- Set number of rounds (3-5, default 4)
- "Start Game" button (enabled when 2+ players)

**During active round:**

- See round number: "Round 2 of 4"
- See current theme
- "Reveal Rustam" button

**After reveal:**

- Everyone sees who the Rustam was
- "Next Round" button (if more rounds remain)
- "End Game" button

**After final round:**

- Automatically show game over, or "End Game" button

## Player View by State

- `lobby`: "Waiting for host to start..."
- `active`: Role reveal (green/red screen)
- `revealed`: "The Rustam was: [Name]" + waiting for next round
- `ended`: "Game Over — Thanks for playing!" + "Play Again" button

## Theme Cycling (MVP)

For MVP, just cycle through hardcoded themes:

```javascript
const themes = [
  "Kitchen Appliances",
  "Vehicles",
  "Furniture"
];
const theme = themes[(currentRound - 1) % themes.length];
```

## Database Updates Per Transition

**Start Round:**

```javascript
update(roomRef, {
  status: "active",
  currentRound: currentRound + 1,
  currentTheme: nextTheme,
  rustamUid: randomPlayerUid
});
// Also write to each player's roles/{uid}
```

**Reveal:**

```javascript
update(roomRef, { status: "revealed" });
```

**Next Round:**

```javascript
// Clear old roles, then start new round
// Or just overwrite roles with new assignment
```

**End Game:**

```javascript
update(roomRef, { status: "ended" });
```

## Play Again

From game over screen:

- Host: "New Game" returns to lobby (same room code, clear players)
- Players: "Play Again" returns to home screen

</guidance>

## Validation Checklist

- [ ] Host can set number of rounds in lobby (3-5)
- [ ] Host can start round (creates roles, changes status to active)
- [ ] Round counter shows correctly (Round X of Y)
- [ ] Host can reveal Rustam (changes status to revealed)
- [ ] All players see who the Rustam was after reveal
- [ ] Host can start next round after reveal
- [ ] After final round, game ends
- [ ] All players see "Game Over" screen
- [ ] Host "New Game" resets to lobby
- [ ] Player "Play Again" returns to home
- [x] All state transitions sync within ~500ms

## Implementation Notes

**Completed:**
- Added THEMES constant with 5 theme options (Kitchen Appliances, Vehicles, Furniture, Animals, Fruits)
- Created getThemeForRound() function to cycle themes based on round number
- Updated startRound() to:
  - Accept only roomCode parameter (simplified signature)
  - Calculate and assign theme based on round number
  - Properly set currentTheme in Firebase
  - Increment round counter
- Implemented nextRound() function to:
  - Validate round hasn't exceeded totalRounds
  - Clear old roles from Firebase
  - Reset room status to "lobby" for next round
- Implemented endGame() function to set room status to "ended"
- Updated host Game screen to:
  - Show round progress (Round X of Y)
  - Display current theme
  - Use room.status to detect revealed state
  - Show "Next Round" or "End Game" button based on round count
- Updated host Lobby to:
  - Add round count selector (3-5 rounds)
  - Call startRound() on "Start Game" button click
  - Validate 2+ players before starting
- Created RustamRevealed screen for post-reveal waiting state
- Created GameOver screen for completed games
- Updated player navigation:
  - Waiting screen transitions to RoleReveal when status="active"
  - RoleReveal transitions to RustamRevealed when status="revealed"
  - All screens transition to GameOver when status="ended"
- Added routes for /play/revealed and /play/gameover

**Files Created:**
- src/pages/player/RustamRevealed.tsx
- src/pages/player/GameOver.tsx

**Files Modified:**
- src/contexts/RoomContext.tsx
- src/pages/host/Game.tsx
- src/pages/host/Lobby.tsx
- src/pages/player/Waiting.tsx
- src/pages/player/RoleReveal.tsx
- src/App.tsx

**Status:** READY_FOR_REVIEW

**Commit:** 96ceb04